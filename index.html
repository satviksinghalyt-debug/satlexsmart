<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SATLEX V9 ‚Äì Groq Notes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* CORE STYLES */
body {background:#050505;color:#e0e0e0;font-family:sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;}
#app {width:90%;max-width:420px;background:#111;border:1px solid #333;border-radius:20px;padding:25px;box-shadow:0 10px 60px rgba(100,50,255,.25);}
h2{color:#a48aff;display:flex;justify-content:space-between;align-items:center;margin:0 0 15px 0;}
.badge{font-size:10px;background:#222;padding:4px 8px;border-radius:4px;color:#aaa;border:1px solid #333;}
#preview{background:#000;border:1px solid #333;color:#bbb;padding:15px;height:90px;overflow-y:auto;font-family:monospace;font-size:13px;border-radius:10px;margin-bottom:15px;}
#output{background:#1a1a1a;border:1px solid #444;border-radius:10px;padding:15px;margin-top:15px;display:none;font-size:15px;line-height:1.6;color:#fff;}
button{width:100%;padding:18px;font-weight:800;border-radius:12px;border:none;cursor:pointer;margin-top:5px;font-size:16px;}
.btn-rec{background:#a48aff;color:#000;}
.btn-stop{background:#fff;color:#000;}
.btn-down{background:#222;color:#a48aff;border:1px solid #444;margin-top:15px;display:none;}
select {width:100%;padding:12px;margin-bottom:15px;background:#222;color:#fff;border:1px solid #444;border-radius:10px;outline:none;}
h3{color:#a48aff;border-bottom:1px solid #333;padding-bottom:5px;margin-top:20px;}
strong{color:#fff;}
ul {padding-left: 20px;}

/* KEY MANAGEMENT STYLES */
.key-controls {display:flex; justify-content:flex-end; margin-bottom:10px;}
#reset-key {background:none; border:none; color:#555; font-size:11px; cursor:pointer; padding:0;}
#reset-key:hover {color:#ff4444;}
</style>
</head>

<body>
<div id="app">
  <h2><span>üü£ SATLEX V9</span><span class="badge">GROQ EDITION</span></h2>
  
  <div class="key-controls">
    <button id="reset-key" onclick="resetKey()">üîë Reset API Key</button>
  </div>

  <select id="mode-select">
    <option value="summary">üìù Summarizer</option>
    <option value="study">üéì Study Guide</option>
    <option value="email">üìß Professional Email</option>
    <option value="code">üíª Code Explainer</option>
  </select>

  <div id="preview">Tap Record...</div>
  <button id="main-btn" class="btn-rec">START RECORDING</button>
  <div id="output"></div>
  <button id="down-btn" class="btn-down">‚¨á SAVE NOTES</button>
</div>

<script>
/* CONFIGURATION */
const GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions";

/* 1. SECURE KEY HANDLING */
let GROQ_KEY = localStorage.getItem("satlex_groq_key");

if (!GROQ_KEY) {
    const userKey = prompt("Enter your Groq API Key (Stored securely in your browser):");
    if (userKey) {
        GROQ_KEY = userKey;
        localStorage.setItem("satlex_groq_key", userKey);
    }
}

function resetKey() {
    localStorage.removeItem("satlex_groq_key");
    location.reload();
}

/* 2. VARIABLES */
let recognition, isRecording=false, finalRaw="";
const btn = document.getElementById("main-btn"),
      btnDown = document.getElementById("down-btn"),
      prev = document.getElementById("preview"),
      out = document.getElementById("output"),
      modeSelect = document.getElementById("mode-select");

/* 3. BROWSER SPEECH RECOGNITION (The "Ear") */
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.onresult = (e) => {
    let txt="";
    for (let i=e.resultIndex;i<e.results.length;i++){
      if (e.results[i].isFinal) txt+=e.results[i][0].transcript;
    }
    prev.innerText += " "+txt;
    prev.scrollTop = prev.scrollHeight;
  };
} else {
    prev.innerText="‚ùå Browser not supported. Use Chrome or Edge.";
}

/* 4. BUTTON LOGIC */
btn.onclick = () => {
  if (!isRecording) startRec(); else stopRec();
};

function startRec(){
  prev.innerText="";
  out.style.display="none";
  btnDown.style.display="none";
  recognition.start();
  isRecording=true;
  btn.className="btn-stop";
  btn.innerText="STOP & PROCESS";
}

function stopRec(){
  recognition.stop();
  isRecording=false;
  btn.innerText="PROCESSING...";
  btn.disabled=true;
  // Send the text caught by the browser to Groq
  callGroq(prev.innerText);
}

/* 5. GROQ API CALL (The "Brain") */
async function callGroq(text) {
  // Guard: Empty text
  if (!text || text.trim() === "") {
     out.innerHTML = `<span style="color:#ff4444">‚ùå Error: No speech detected. Try speaking louder or check microphone permissions.</span>`;
     out.style.display="block";
     btn.disabled=false;
     btn.innerText="START RECORDING";
     btn.className="btn-rec";
     return;
  }
  
  // Guard: No Key
  if (!GROQ_KEY) {
      alert("No API Key found. Please reset and enter a key.");
      btn.disabled=false;
      btn.innerText="START RECORDING";
      return;
  }

  // Determine Prompt
  const mode = modeSelect.value;
  let sysPrompt = "You are a helpful assistant. Format this nicely.";
  
  if(mode === "summary") sysPrompt = "You are an expert note-taker. Organize this into: 1) Summary, 2) Key Bullet Points, 3) Action Items.";
  if(mode === "study") sysPrompt = "You are a tutor. Create a study guide with definitions, key dates, and a short quiz.";
  if(mode === "email") sysPrompt = "You are a professional secretary. Draft a polite, professional email based on this text.";
  if(mode === "code") sysPrompt = "You are a senior developer. Convert this logic/speech into clear Pseudocode or Python snippets with comments.";

  try {
    const res = await fetch(GROQ_API_URL, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${GROQ_KEY}`
      },
      body: JSON.stringify({
        // ‚úÖ CORRECT MODEL: Using Llama 3.3 because we are processing TEXT.
        model: "llama-3.3-70b-versatile", 
        messages: [
            { role: "system", content: sysPrompt },
            { role: "user", content: text }
        ],
        temperature: 0.7,
        max_tokens: 1024
      })
    });

    const data = await res.json();
    
    // API Error Handling
    if (data.error) {
        if(data.error.code === 'invalid_api_key' || data.error.message.includes('key')) {
            alert("Invalid API Key. Please reset it.");
            resetKey();
        }
        throw new Error(data.error.message || "Groq API Error");
    }

    let aiText="";
    if (data.choices && data.choices.length > 0 && data.choices[0].message){
      aiText = data.choices[0].message.content;
    }

    if (!aiText) throw new Error("Empty AI response");

    finalRaw = aiText;
    renderMarkdown(aiText);

  } catch(e) {
    console.error(e);
    out.innerHTML = `<span style="color:#ff4444">‚ùå API Error: ${e.message}</span>`;
    out.style.display="block";
  }

  btn.disabled=false;
  btn.className="btn-rec";
  btn.innerText="START RECORDING";
}

/* 6. RENDER MARKDOWN */
function renderMarkdown(md){
  if(!md){
    out.innerHTML="‚ùå No response.";
    out.style.display="block";
    return;
  }
  let html = md
    .replace(/^### (.*$)/gim,'<h3>$1</h3>')
    .replace(/^## (.*$)/gim,'<h2>$1</h2>')
    .replace(/^# (.*$)/gim,'<h1>$1</h1>')
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
    .replace(/^\* /gim,'‚Ä¢ ') 
    .replace(/\n/g, '<br>');

  out.innerHTML=html;
  out.style.display="block";
  btnDown.style.display="block";
}

/* 7. DOWNLOAD BUTTON */
btnDown.onclick = ()=>{
  const blob = new Blob([finalRaw],{type:'text/markdown'});
  const a = document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="Satlex_Notes.md";
  a.click();
};
</script>
</body>
</html>
